name: SSH Handshake Test

on:
  workflow_dispatch:

jobs:
  ssh-test:
    runs-on: ubuntu-latest
    steps:
          - name: Install cloudflared
            run: |
              curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 \
                -o cloudflared
              chmod +x cloudflared
              sudo mv cloudflared /usr/local/bin/cloudflared
    
          - name: Prepare SSH
            run: |
              mkdir -p ~/.ssh
              echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
              chmod 600 ~/.ssh/id_ed25519
    
              cat <<EOF > ~/.ssh/config
              Host ssh.tushar.sbs
                User deploy
                IdentityFile ~/.ssh/id_ed25519
                ProxyCommand cloudflared tunnel ssh --hostname %h
                StrictHostKeyChecking no
              EOF
    
          - name: Handshake test
            run: |
              ssh -vvv ssh.tushar.sbs "echo CONNECTED && whoami && hostname"
